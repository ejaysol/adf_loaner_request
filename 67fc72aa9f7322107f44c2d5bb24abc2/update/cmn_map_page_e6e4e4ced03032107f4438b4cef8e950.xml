<?xml version="1.0" encoding="UTF-8"?><record_update table="cmn_map_page">
    <cmn_map_page action="INSERT_OR_UPDATE">
        <center_address>Yogododji, Africa</center_address>
        <center_latitude/>
        <center_longitude/>
        <controls_size>large</controls_size>
        <coordinates_retrieved_on/>
        <disable_map_controls/>
        <disable_nav_bar>false</disable_nav_bar>
        <filter/>
        <initial_zoom>2</initial_zoom>
        <name>x_cdltd_loanerrequ_Requested for Locatio</name>
        <overview>false</overview>
        <refresh_on_zoom>false</refresh_on_zoom>
        <roles/>
        <script><![CDATA[// Let's go get all the active Loaner Requests where the requestor has a _city and country_ in their user record
var gr = new GlideRecord('x_cdltd_loanerrequ_loaner_request');
gr.addEncodedQuery("active=true^requested_for.cityISNOTEMPTY^requested_for.countryISNOTEMPTY");
gr.orderBy('number');
gr.query();

// Now, loop through these results...
while (gr.next()) {
    
    // ...but, within THESE results, let's get the LABEL of the country field (via the sys_choice table), since our REST provider prefers that.
    var countrygr = new GlideRecord('sys_choice');
    countrygr.addQuery('name', 'sys_user');
    countrygr.addQuery('element', 'country');
    countrygr.addQuery('language', 'en');
    countrygr.addQuery('value', gr.requested_for.country);
    countrygr.query();

    if (countrygr.next()) {
        
        // --- REST Message Execution ---
        var query = gr.requested_for.city + "," + countrygr.label;
        var r = new sn_ws.RESTMessageV2('x_cdltd_loanerrequ.Get Lat Long', 'Default GET');
        r.setStringParameterNoEscape('text', query);
        var response = r.execute();
        var responseBody = response.getBody();
        var httpStatus = response.getStatusCode();
        // --- REST Message Execution ---
        
        // --- START of Error Handling and Coordinate Extraction (Moved Inside) ---
        
        // Check for a successful HTTP status (e.g., 200 or 201)
        if (httpStatus >= 200 && httpStatus < 300) {
            try {
                // Extract latitude and longitude values from REST Message response in JSON format
                var responseJSON = JSON.parse(responseBody);
                
                // Safety check: Ensure the features array exists and has at least one element
                if (responseJSON.features && responseJSON.features.length > 0) {
                    var myLat = responseJSON.features[0].properties.lat;
                    var myLong = responseJSON.features[0].properties.lon;

                    // Plot each 'Requested for' location on a Google map
                    var item = map.addItem(gr);
                    item.latitude = String(myLat);
                    item.longitude = String(myLong);
                    item.dialog_title = gr.getDisplayValue();
                    item.icon = "https://maps.google.com/mapfiles/ms/micons/yellow.png";
                    item.icon_width = "32";
                    item.icon_height = "32";
                } else {
                    gs.log("Loaner Request Map: No features found for query: " + query);
                }
            } catch (e) {
                // Catch JSON parsing errors
                gs.log("Loaner Request Map Error: Failed to parse JSON response for query " + query + ". Error: " + e.message);
            }
        } else {
            // Log if the REST call failed (e.g., HTTP 401, 404, 500)
            gs.log("Loaner Request Map Error: REST call failed for query " + query + ". Status: " + httpStatus + ", Body: " + responseBody);
        }
        
        // --- END of Error Handling and Coordinate Extraction ---
    } else {
        gs.log("Loaner Request Map: No country label found in sys_choice for value: " + gr.requested_for.country);
    }
}]]></script>
        <show_device_location>true</show_device_location>
        <suffix>Requested for Locations</suffix>
        <sys_class_name>cmn_map_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-10-26 07:40:47</sys_created_on>
        <sys_id>e6e4e4ced03032107f4438b4cef8e950</sys_id>
        <sys_mod_count>6</sys_mod_count>
        <sys_name>x_cdltd_loanerrequ_Requested for Locatio</sys_name>
        <sys_package display_value="LoanerRequest" source="x_cdltd_loanerrequ">67fc72aa9f7322107f44c2d5bb24abc2</sys_package>
        <sys_policy/>
        <sys_scope display_value="LoanerRequest">67fc72aa9f7322107f44c2d5bb24abc2</sys_scope>
        <sys_update_name>cmn_map_page_e6e4e4ced03032107f4438b4cef8e950</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-10-26 08:32:34</sys_updated_on>
        <type>terrain</type>
        <type_selection>buttons</type_selection>
        <use_advanced_configuration>false</use_advanced_configuration>
    </cmn_map_page>
</record_update>
